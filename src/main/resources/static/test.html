<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ESP32 WiFi Provisioning</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select { margin: 5px 0; padding: 5px; width: 250px; }
    button { padding: 6px 12px; margin: 5px; }
  </style>
</head>
<body>
<h1>ESP32 WiFi Provisioning</h1>

<button id="connectBtn">ğŸ”— ESP32 ì—°ê²°</button><br><br>

<label>WiFi ëª©ë¡:<br>
  <select id="wifiListSelect">
    <option value="">WiFi ë„¤íŠ¸ì›Œí¬ ì„ íƒ...</option>
  </select>
</label><br>

<label>SSID:<br>
  <input type="text" id="ssidInput" placeholder="WiFi SSID">
</label><br>

<label>Password:<br>
  <input type="password" id="passInput" placeholder="WiFi Password">
</label><br>

<button id="sendBtn">ğŸ“¡ ì „ì†¡</button>

<pre id="log"></pre>

<script>
  const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
  const SSID_CHAR_UUID = "abcd1234-5678-90ab-cdef-1234567890ab";
  const PASS_CHAR_UUID = "abcd5678-1234-90ab-cdef-1234567890ab";
  const SCAN_RESULT_UUID = "abcd9999-1234-90ab-cdef-1234567890ab";

  let ssidCharacteristic;
  let passCharacteristic;
  let scanResultCharacteristic;
  const logArea = document.getElementById("log");
  const wifiListSelect = document.getElementById("wifiListSelect");

  function log(msg) {
    logArea.textContent += msg + "\n";
  }

  function updateWiFiList(wifiString) {
    const networks = wifiString.split("\n").filter(n => n.trim().length > 0);
    wifiListSelect.innerHTML = `<option value="">WiFi ë„¤íŠ¸ì›Œí¬ ì„ íƒ...</option>`;
    networks.forEach(net => {
      const option = document.createElement("option");
      option.value = net;
      option.textContent = net;
      wifiListSelect.appendChild(option);
    });
    log("ğŸ“‹ WiFi ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  }

  async function connectESP32() {
    try {
      log("ğŸ” BLE ê¸°ê¸° ê²€ìƒ‰ ì¤‘...");
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }]
      });

      log(`âœ… ê¸°ê¸° ì„ íƒë¨: ${device.name}`);
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);

      ssidCharacteristic = await service.getCharacteristic(SSID_CHAR_UUID);
      passCharacteristic = await service.getCharacteristic(PASS_CHAR_UUID);
      scanResultCharacteristic = await service.getCharacteristic(SCAN_RESULT_UUID);

      log("ğŸ“¡ ESP32 BLE ì„œë¹„ìŠ¤ ì—°ê²° ì™„ë£Œ");

      // ì´ˆê¸° ëª©ë¡ ì½ê¸°
      const value = await scanResultCharacteristic.readValue();
      updateWiFiList(new TextDecoder().decode(value));

      // ë³€ê²½ ì•Œë¦¼(Notify) êµ¬ë…
      scanResultCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
        const value = new TextDecoder().decode(event.target.value);
        updateWiFiList(value);
      });
      await scanResultCharacteristic.startNotifications();

    } catch (error) {
      log(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error}`);
    }
  }

  async function sendWiFiCredentials(ssid, password) {
    if (!ssidCharacteristic || !passCharacteristic) {
      log("âš ï¸ ë¨¼ì € ì—°ê²°ì„ í•´ì£¼ì„¸ìš”");
      return;
    }
    try {
      await ssidCharacteristic.writeValue(new TextEncoder().encode(ssid));
      log(`ğŸ“¤ SSID ì „ì†¡: ${ssid}`);

      await passCharacteristic.writeValue(new TextEncoder().encode(password));
      log("ğŸ“¤ Password ì „ì†¡ ì™„ë£Œ");
    } catch (error) {
      log(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error}`);
    }
  }

  wifiListSelect.addEventListener("change", () => {
    document.getElementById("ssidInput").value = wifiListSelect.value;
  });

  document.getElementById("connectBtn").addEventListener("click", connectESP32);
  document.getElementById("sendBtn").addEventListener("click", () => {
    const ssid = document.getElementById("ssidInput").value;
    const pass = document.getElementById("passInput").value;
    sendWiFiCredentials(ssid, pass);
  });
</script>
</body>
</html>
